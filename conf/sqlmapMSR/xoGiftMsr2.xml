<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="xoGiftMsr2">
    <select id="xoGiftMsr2.findMsrTrdXoGiftList"
            parameterClass="co.kr.istarbucks.xo.batch.common.dto.xo.GiftOrderHistoryDto"
            resultClass="co.kr.istarbucks.xo.batch.common.dto.msr.TrdXoGiftList">
        SELECT /*+ INDEX (mtxgl IDX_MSR_TRD_XO_GIFT_LIST_01 ) */
               BUSINESS_DATE,
               BRANCH_CODE,
               POS_NUMBER,
               POS_TRD_NUMBER,
               GIFT_NO,
               TOTAL_TRD_AMOUNT,
               TRD_AMOUNT
          FROM MSR_TRD_XO_GIFT_LIST mtxgl
         WHERE BUSINESS_DATE    = #sale_date#
           AND BRANCH_CODE      = #store_cd#
           AND POS_NUMBER       = #pos_no#
           AND POS_TRD_NUMBER   = #seq_no#
           AND GIFT_NO          = #gift_no#
    </select>

    <select id="xoGiftMsr2.findMsrDupTrdXoGiftList"
            parameterClass="co.kr.istarbucks.xo.batch.common.dto.xo.GiftOrderHistoryDto"
            resultClass="co.kr.istarbucks.xo.batch.common.dto.msr.TrdXoGiftList">
        SELECT BUSINESS_DATE,
               BRANCH_CODE,
               POS_NUMBER,
               POS_TRD_NUMBER,
               GIFT_NO,
               TOTAL_TRD_AMOUNT,
               TRD_AMOUNT
          FROM MSR_DUP_TRD_XO_GIFT_LIST
         WHERE BUSINESS_DATE    = #sale_date#
           AND BRANCH_CODE      = #store_cd#
           AND POS_NUMBER       = #pos_no#
           AND POS_TRD_NUMBER   = #seq_no#
           AND GIFT_NO          = #gift_no#
    </select>

	<!-- 별 이력번호(영업일자+SEQ) 조회 -->
    <select id="xoGiftMsr2.getStarSeqNo" resultClass="java.lang.String">
        SELECT SE_MSR_STAR_NO.NEXTVAL FROM DUAL
    </select>
    
    <!--    취소 기한 만료 별 발행   -->
    <insert id="xoGiftMsr2.saveIrrevocableGiftOrderEventStar" parameterClass="co.kr.istarbucks.xo.batch.egiftitem.StarListDto">
        INSERT
          INTO MSR_STAR_LIST## (
               STAR_SEQ,
               USER_NUMBER,
               STAR_GRP_SEQ,
               EXPIRE_DATE,
               STAR_FLAG,
               STAR_COUNT,
               EXTRA_STAR_ALL_CNT,
               EVENT_NO,
               GRANT_DESC,
               REG_DATE
        )
        VALUES (
               #star_seq#,
               #user_number#,
               #star_grp_seq#,
               ADD_MONTHS(SYSDATE + 1, (SELECT STAR_EXPIRATION_YEAR * 12 FROM MSR_REWARD_POLICY)),
               'I',
               1,
               #extra_star_all_cnt#,
               #event_no#,
               '>>>',
               SYSDATE
        )
    </insert>


    <!--    'USER_ID'를 식별자로 갖는 정상 상태의 사용자 조회    -->
    <select id="xoGiftMsr2.findCardRegMemberByUserIDAndUserStatusIsJ"
            parameterClass="java.lang.String"
            resultClass="co.kr.istarbucks.xo.batch.common.dto.msr.CardRegMemberDto">
        SELECT USER_NUMBER
          FROM MSR_CARD_REG_MEMBER
         WHERE USER_ID = #value#
           AND USER_STATUS = 'J'
    </select>
    
</sqlMap>
