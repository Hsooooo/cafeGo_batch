<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="nonMember">

	<!-- 비회원 주문 가상 사용자 정보(MSR_XO_NON_MEMBER) 조회 -->
	<resultMap class="java.util.HashMap" id="nonMemberMap">
		<result property="userNumber" 			column="user_number" 			javaType="java.lang.String"/>
		<result property="userId" 				column="user_id" 				javaType="java.lang.String"/>
		<result property="ci" 					column="ci" 					javaType="java.lang.String"/>
		<result property="di" 					column="di" 					javaType="java.lang.String"/>
		<result property="type" 				column="type" 					javaType="java.lang.String"/>
		<result property="status" 				column="status" 				javaType="java.lang.String"/>
		<result property="accAmt" 				column="acc_amt" 				javaType="java.lang.Integer"/>
		<result property="accRewardAmt" 		column="acc_reward_amt" 		javaType="java.lang.Integer"/>
		<result property="rewardExpireDate" 	column="reward_expire_date" 	javaType="java.lang.String"/>
		<result property="transferGb" 			column="transfer_gb" 			javaType="java.lang.String"/>	
		<result property="transferUserNumber" 	column="transfer_user_number" 	javaType="java.lang.String"/>	
	</resultMap>
	<select id="nonMember.getNonMemberInfo" parameterClass="java.util.Map" resultMap="nonMemberMap">
		SELECT USER_NUMBER									
			   , USER_ID					 			
			   , CI							 			
			   , DI							 			
			   , TYPE						 			
			   , STATUS					 						
			   , NVL(ACC_AMT, 0) AS	ACC_AMT		 					
			   , NVL(ACC_REWARD_AMT, 0) AS	ACC_REWARD_AMT		 	
			   , NVL(REWARD_EXPIRE_DATE, '') AS	REWARD_EXPIRE_DATE	
			   , CASE WHEN STATUS = 'D'
		          	  THEN 
			             CASE WHEN WEB_USER_NUMBER IS NULL AND MSR_USER_NUMBER IS NULL
			               		THEN 'NOT'
	                      	  WHEN WEB_USER_NUMBER IS NULL AND MSR_USER_NUMBER IS NOT NULL
			               		THEN 'MSR' 
	                      	  WHEN WEB_USER_NUMBER IS NOT NULL AND MSR_USER_NUMBER IS NULL
			               		THEN 'WEB' 
			             END
		          	  ELSE 'NOT'
		         END AS TRANSFER_GB								
		       , CASE WHEN STATUS = 'D'
		          	  THEN 
			             CASE WHEN WEB_USER_NUMBER IS NULL AND MSR_USER_NUMBER IS NULL
			               		THEN USER_NUMBER
	                      	  WHEN WEB_USER_NUMBER IS NULL AND MSR_USER_NUMBER IS NOT NULL
			               		THEN MSR_USER_NUMBER 
	                      	  WHEN WEB_USER_NUMBER IS NOT NULL AND MSR_USER_NUMBER IS NULL
			               		THEN WEB_USER_NUMBER 
			             END
		          	  ELSE USER_NUMBER
		         END AS TRANSFER_USER_NUMBER				
		  FROM MSR_XO_NON_MEMBER
		 WHERE 1 = 1
		 <isNotEmpty property="di">
		   AND DI = #di#
		 </isNotEmpty>
		 <isNotEmpty property="userId">
		   AND USER_ID = UPPER(#userId#)
		 </isNotEmpty>
		 <isNotEmpty property="userNumber">
		   AND USER_NUMBER = #userNumber#
		 </isNotEmpty>
		 <isNotEmpty property="status">
		   AND STATUS = #status#
		 </isNotEmpty>
	</select>
	
	<!-- 웹회원 주문 가상 사용자 정보(MSR_XO_NON_MEMBER) 조회 -->
	<resultMap class="java.util.HashMap" id="webMemberMap">
		<result property="userNumber" 			column="user_number" 			javaType="java.lang.String"/>
		<result property="userId" 				column="user_id" 				javaType="java.lang.String"/>
		<result property="ci" 					column="ci" 					javaType="java.lang.String"/>
		<result property="di" 					column="di" 					javaType="java.lang.String"/>
		<result property="type" 				column="type" 					javaType="java.lang.String"/>
		<result property="status" 				column="status" 				javaType="java.lang.String"/>
		<result property="accAmt" 				column="acc_amt" 				javaType="java.lang.Integer"/>
		<result property="accRewardAmt" 		column="acc_reward_amt" 		javaType="java.lang.Integer"/>
		<result property="rewardExpireDate" 	column="reward_expire_date" 	javaType="java.lang.String"/>
		<result property="transferGb" 			column="transfer_gb" 			javaType="java.lang.String"/>	
		<result property="transferUserNumber" 	column="transfer_user_number" 	javaType="java.lang.String"/>
	</resultMap>
	<select id="nonMember.getWebMemberInfo" parameterClass="java.lang.String" resultMap="webMemberMap">
		SELECT USER_NUMBER								
			   , USER_ID					 					
			   , CI							 					
			   , DI							 					
			   , TYPE						 					
			   , STATUS					 						
			   , NVL(ACC_AMT, 0) AS	ACC_AMT		 					
			   , NVL(ACC_REWARD_AMT, 0) AS	ACC_REWARD_AMT		 	
			   , NVL(REWARD_EXPIRE_DATE, '') AS	REWARD_EXPIRE_DATE	
			   , CASE WHEN STATUS = 'D'
		          	  THEN 
			             CASE WHEN WEB_USER_NUMBER IS NULL AND MSR_USER_NUMBER IS NULL
			               		THEN 'NOT'
	                      	  WHEN WEB_USER_NUMBER IS NULL AND MSR_USER_NUMBER IS NOT NULL
			               		THEN 'MSR' 
	                      	  WHEN WEB_USER_NUMBER IS NOT NULL AND MSR_USER_NUMBER IS NULL
			               		THEN 'WEB' 
			             END
		          	  ELSE 'NOT'
		         END AS TRANSFER_GB									
		       , CASE WHEN STATUS = 'D'
		          	  THEN 
			             CASE WHEN WEB_USER_NUMBER IS NULL AND MSR_USER_NUMBER IS NULL
			               		THEN USER_NUMBER
	                      	  WHEN WEB_USER_NUMBER IS NULL AND MSR_USER_NUMBER IS NOT NULL
			               		THEN MSR_USER_NUMBER 
	                      	  WHEN WEB_USER_NUMBER IS NOT NULL AND MSR_USER_NUMBER IS NULL
			               		THEN WEB_USER_NUMBER 
			             END
		          	  ELSE USER_NUMBER
		         END AS TRANSFER_USER_NUMBER					
		  FROM MSR_XO_NON_MEMBER
		 WHERE TYPE = 'W'
		   AND USER_NUMBER = #webUserNumber#
	</select>
	
 	<!-- 비회원 주문 거래 이력(MSR_XO_NON_TRD_HIST) 저장 -->
	<insert id="nonMember.insertNonMemberTrdHist" parameterClass="java.util.Map">
		INSERT INTO MSR_XO_NON_TRD_HIST (DI			
					, USER_NUMBER					
					, TRD_TYPE						
					, AMOUNT						
					, ACC_AMT						
					, ACC_REWARD_AMT				
					, ORDER_NO						
					, BUSINESS_DATE					
					, BRANCH_CODE					
					, POS_NUMBER					
					, POS_TRD_NUMBER				
					, RWD_TRD_YN					
					<isNotEmpty property="couponNumber">
						, COUPON_NUMBER				
					</isNotEmpty>
					, REG_DATE)
			VALUES (
					#di#						
					, #userNumber#				
					, #trdType#					
					, #amount#					
					, #accAmt#					
					, #accRewardAmt#			
					, #orderNo#					
					, #businessDate#			
					, #branchCode#				
					, #posNumber#				
					, #posTrdNumber#			
					, #rwdTrdYn#				
					<isNotEmpty property="couponNumber">
						, #couponNumber#		
					</isNotEmpty>
					, SYSDATE)
	</insert>
	
	<!-- 비회원 주문 가상 사용자 정보(MSR_XO_NON_MEMBER)에 사용자 누적 사용 금액 / 리워드 대상 누적 금액 변경 -->
 	<update id="nonMember.updateNonMemberInfo" parameterClass="java.util.Map">
		UPDATE MSR_XO_NON_MEMBER 
		   SET ACC_AMT = #accAmt#						
		   	   , ACC_REWARD_AMT = #accRewardAmt#			
		   	   <isNotEmpty property="rewardExpireDate">
		   	   , REWARD_EXPIRE_DATE = #rewardExpireDate#	
		   	   </isNotEmpty>
		   	   , MOD_DATE = SYSDATE
		 WHERE USER_NUMBER = #userNumber#
		   AND DI = #di#
 	</update>
 	
 	<!-- 사용 가능한 쿠폰 개수 조회  -->
 	<select id="nonMember.getNonMembAvlblCouponCnt" parameterClass="java.util.Map" resultClass="java.lang.Integer">
 		SELECT COUNT(*) 
 		  FROM MSR_COUPON_PUBLICATION_LIST
 		 WHERE GIFT_SEND_COUPON_NUM IS NULL
           AND COUPON_STATUS = 'A'
           AND USER_NUMBER = #userNumber#
           AND EXPIRE_START_DATE <![CDATA[ <= ]]> SYSDATE
		   AND EXPIRE_END_DATE <![CDATA[ >= ]]> TO_DATE(#rewardExpireDate#||'235959', 'YYYYMMDDHH24MISS')
 	</select>
 	
 	<!-- 비회원 주문 거래 사용금액(MSR_XO_NON_TRD_HIST) 조회 -->
 	<select id="nonMember.getNonMemTrdAmtInfo" parameterClass="java.lang.String" resultClass="java.lang.Integer">
		SELECT NVL(SUM(DECODE(TRD_TYPE, 'X', -AMOUNT, AMOUNT)), 0)
		  FROM MSR_XO_NON_TRD_HIST
		 WHERE ORDER_NO = #xopOrdNo#
		   AND TRD_TYPE IN ('U','X')
	</select>
	
 	<!-- 비회원 주문 거래 이력(MSR_XO_NON_TRD_HIST) 조회 -->
	<resultMap class="java.util.HashMap" id="nonMemberTrdHistMap">
		<result property="di" 				column="di" 				javaType="java.lang.String"/>
		<result property="userNumber" 		column="user_number" 		javaType="java.lang.String"/>
		<result property="accAmt" 			column="acc_amt" 			javaType="java.lang.Integer"/>
		<result property="accRewardAmt" 	column="acc_reward_amt" 	javaType="java.lang.Integer"/>
		<result property="businessDate" 	column="business_date" 		javaType="java.lang.String"/>
		<result property="branchCode" 		column="branch_code" 		javaType="java.lang.String"/>
		<result property="posNumber" 		column="pos_number" 		javaType="java.lang.String"/>
		<result property="posTrdNumber" 	column="pos_trd_number" 	javaType="java.lang.String"/> 
	</resultMap>
	<select id="nonMember.getNonMemTrdHist" parameterClass="java.lang.String" resultMap="nonMemberTrdHistMap">
		SELECT DI							 						
			   , USER_NUMBER					 					
			   , NVL(ACC_AMT, 0) AS	ACC_AMT		 					
			   , NVL(ACC_REWARD_AMT, 0) AS	ACC_REWARD_AMT		 	
			   , BUSINESS_DATE
			   , BRANCH_CODE 
			   , POS_NUMBER 
			   , POS_TRD_NUMBER
		  FROM MSR_XO_NON_TRD_HIST
		 WHERE ORDER_NO = #xopOrdNo#
		   AND TRD_TYPE = 'U'
		   AND ROWNUM = 1
	</select>
	
	<!-- 보유쿠폰(상태:'A')정보 조회 -->
 	<select id="nonMember.getPosseCouponInfo" parameterClass="java.util.Map" resultClass="co.kr.istarbucks.xo.batch.common.dto.msr.CouponPublicationDto">
 		SELECT cpl.COUPON_NUMBER AS couponNumber
 		  FROM MSR_COUPON_PUBLICATION_LIST cpl
       		   , (
       		   	  SELECT CASE WHEN STATUS = 'D'
		          				THEN 
						             CASE WHEN WEB_USER_NUMBER IS NULL AND MSR_USER_NUMBER IS NULL
						               		THEN USER_NUMBER
				                      	  WHEN WEB_USER_NUMBER IS NULL AND MSR_USER_NUMBER IS NOT NULL
						               		THEN MSR_USER_NUMBER 
				                      	  WHEN WEB_USER_NUMBER IS NOT NULL AND MSR_USER_NUMBER IS NULL
						               		THEN WEB_USER_NUMBER 
						             END
		          	  			ELSE USER_NUMBER
		         		 END AS TRANSFER_USER_NUMBER
		         		 , USER_NUMBER
		         		 , DI
          			FROM MSR_XO_NON_MEMBER
          		   ) xnm
          	   , MSR_XO_NON_TRD_HIST xnth
         WHERE cpl.USER_NUMBER = #transferUserNumber#
           AND cpl.COUPON_STATUS = 'A'
           AND cpl.GIFT_SEND_COUPON_NUM IS NULL
           AND xnth.USER_NUMBER = xnm.USER_NUMBER
           AND cpl.COUPON_NUMBER = xnth.COUPON_NUMBER
           AND cpl.EXPIRE_START_DATE <![CDATA[ <= ]]> SYSDATE
		   AND cpl.EXPIRE_END_DATE <![CDATA[ >= ]]> TO_DATE(#businessDate#||'235959', 'YYYYMMDDHH24MISS')
           AND xnth.TRD_TYPE = 'R'
           AND xnm.DI = #di#
           AND xnm.USER_NUMBER = (
           						  SELECT USER_NUMBER 
           						    FROM MSR_XO_NON_TRD_HIST
           						   WHERE TRD_TYPE = 'U'
           						   	 AND BUSINESS_DATE        = #businessDate#
           						   	 AND BRANCH_CODE          = #branchCode# 
           						   	 AND POS_NUMBER           = #posNumber# 
           						   	 AND POS_TRD_NUMBER       = #posTrdNumber#
           						   	 AND ORDER_NO             = #orderNo#
           						 )
 	</select>
	
	<!-- 쿠폰 회수(MSR_COUPON_PUBLICATION_LIST) 처리 -->
	<update id="nonMember.updateExpireCoupon" parameterClass="java.lang.String">
		UPDATE MSR_COUPON_PUBLICATION_LIST
		   SET COUPON_STATUS = 'C'
 	     WHERE COUPON_NUMBER = #couponNumber#
	</update>
	
	<!-- 거래 마스터(MSR_TRD_MASTER)에 거래(X:사용취소)내역 생성 및 거래번호 조회 -->
	<insert id="nonMember.insertTrdMaster" parameterClass="java.util.Map">
		<selectKey resultClass="java.lang.Integer" keyProperty="trdSeq">
			SELECT SEQ_MSR_TRD_MASTER.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO MSR_TRD_MASTER (TRD_SEQ	
					, BUSINESS_DATE			
					, BRANCH_CODE			
					, POS_NUMBER				
					, POS_TRD_NUMBER			
					, XO_ORDER_NO				
					, TRD_TYPE					
					, REG_DATE)					
			VALUES (
					#trdSeq#					
					, #trdBusinessDate#			
					, #trdBranchCode#			
					, #trdPosNumber#			
					, #trdPosTrdNumber#			
					, #orderNo#					
					, 'X'						
					, SYSDATE)					
	</insert>
	
	<!-- 쿠폰 회수 이력(MSR_TRD_COUPON_LIST) 생성 -->
	<insert id="nonMember.insertTrdCoupon" parameterClass="java.util.Map">
		INSERT INTO MSR_TRD_COUPON_LIST (COUPON_NUMBER		
					, CAN_BUSINESS_DATE						
					, CAN_BRANCH_CODE						
					, CAN_BRANCH_NAME						
					, TRD_SEQ								
					, COUPON_CANCEL_DATE)					
		    VALUES (
		    		#couponNumber#								
		    		, #trdBusinessDate#							
		    		, #trdBranchCode#							
		    		, (SELECT BRANCH_NAME 
		    			 FROM MSR_BRANCH_INFO 
		    			WHERE BRANCH_CODE = #trdBranchCode#)	
		    		, #trdSeq#									
		            , SYSDATE)									
	</insert>

</sqlMap>