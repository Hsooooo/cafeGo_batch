<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="msReview">

	<typeAlias alias="MsrvInfrmMasterDto" type="co.kr.istarbucks.xo.batch.common.dto.xo.MsrvInfrmMasterDto" />
	
	
	<!-- 마이스타벅스리뷰 마스터 정보 -->
	<select id="msReview.getMsrvInfrmMasterInfo" parameterClass="java.util.Map" resultClass="MsrvInfrmMasterDto">
		SELECT #order_no#						AS orderNo
			 , #user_id#						AS userId
			 , sub.MSRV_SRNM					AS msrvSrnm
			 , sub.MSRV_TITLE_NAME				AS msrvTitleName
			 , sub.MSRV_DVSN_CODE				AS msrvDvsnCode
			 , sub.PRTCN_TRPR_RSTRC_YN			AS prtcnTrprRstrcYn
			 , sub.PRTCN_TRPR_RSTRC_PRCNT		AS prtcnTrprRstrcPrcnt
			 , sub.PRTCN_PRCNT					AS prtcnPrcnt
			 , sub.GNR_CODE						AS gnrCode
			 , sub.MSR_GRADE_CODE_DTLS			AS msrGradeCodeDtls
			 , sub.BIRTH_YRWN_APLCT_YN			AS birthYrwnAplctYn
			 , sub.ORDER_TME_APLCT_YN			AS orderTmeAplctYn
			 , sub.STORE_ATRBT_APLCT_YN			AS storeAtrbtAplctYn
			 , sub.GOODS_INFRM_APLCT_YN			AS goodsInfrmAplctYn
			 , sub.GOODS_INFRM_PRNG_YN			AS goodsInfrmPrngYn
			 , sub.PILOT_YN						AS pilotYn
			 , sub.MSRV_MBBR_DVSN_CODE			AS msrvMbbrDvsnCode
			 , sub.CURR_ORDER_DATE				AS currOrderDate
		  FROM (
				SELECT mi.MSRV_SRNM
				     , mi.MSRV_TITLE_NAME
				     , mi.MSRV_DVSN_CODE
				     , mi.PRTCN_TRPR_RSTRC_YN
				     , NVL(mi.PRTCN_TRPR_RSTRC_PRCNT, 0)	AS PRTCN_TRPR_RSTRC_PRCNT
					 , NVL(mi.PRTCN_PRCNT, 0)				AS PRTCN_PRCNT  	
				     , mi.GNR_CODE
				     , mi.MSR_GRADE_CODE_DTLS
				     , mi.BIRTH_YRWN_APLCT_YN
				     , mi.ORDER_TME_APLCT_YN
				     , mi.STORE_ATRBT_APLCT_YN
				     , mi.GOODS_INFRM_APLCT_YN
				     , mi.GOODS_INFRM_PRNG_YN
				     , mi.PILOT_YN
				   	 , 'N' 									AS MSRV_MBBR_DVSN_CODE
				   	 , (SELECT TO_CHAR(xo.ORDER_DATE, 'YYYYMMDDHH24MISS')
						  FROM XO_ORDER## xo
						 WHERE xo.ORDER_NO = #order_no#
						   AND TO_CHAR(xo.ORDER_DATE, 'YYYYMMDD') = TO_CHAR(SYSDATE, 'YYYYMMDD')
						   AND xo.STATUS IN ('31', '30'))	AS CURR_ORDER_DATE			
				  FROM XO_MSRV_INFRM_M mi
				 WHERE mi.XPSR_YN = 'Y'
				   AND SYSDATE BETWEEN mi.PSTNG_BEGIN_DTM AND mi.PSTNG_TRMNT_DTM
				   AND mi.DLT_YN = 'N'
				   AND mi.PILOT_YN = 'N'
				) sub
	</select>
	
	<!-- 현재 설문 참여인원수 조회 -->
	<select id="msReview.getMsrvPrtcnPrcnt" parameterClass="java.util.Map" resultClass="java.lang.Integer">
		SELECT COUNT(*)
		  FROM (
		  		SELECT /*+ INDEX(mpt IDX_XO_MSRV_PRTCN_TRPR_H_002) */
					   mpt.MSRMB_ID, COUNT(mpt.MSRMB_ID)
		          FROM XO_MSRV_PRTCN_TRPR_H mpt 
		         WHERE mpt.MSRV_SRNM = TO_NUMBER(#msrv_srnm#)
		           AND mpt.MSRV_MBBR_DVSN_CODE = 'N'
		         GROUP BY mpt.MSRMB_ID
		  		)
	</select>
	
	<!-- 마이스타벅스리뷰 사전대상자 유무 조회 -->
	<select id="msReview.getMsrvBfrhnTrprCount" parameterClass="java.util.Map" resultClass="java.lang.Integer">
		SELECT COUNT(*)
		  FROM XO_MSRV_BFRHN_TRPR_D
		 WHERE MSRV_SRNM = TO_NUMBER(#msrv_srnm#)
		   AND MSRMB_ID  = #msrmb_id#
		   AND MSRV_MBBR_DVSN_CODE = 'N'
	</select>
	
	<!-- 마이스타벅스리뷰 시간정보의 등록순번 조회 -->
	<select id="msReview.getTmeRgsttSrnm" parameterClass="java.util.Map" resultClass="java.lang.String">
		SELECT tme_rgstt_srnm
		  FROM (
				SELECT TO_CHAR(WM_CONCAT(DISTINCT RGSTT_SRNM) OVER (PARTITION BY MSRV_SRNM)) AS tme_rgstt_srnm
				  FROM XO_MSRV_TME_D
				 WHERE MSRV_SRNM = TO_NUMBER(#msrv_srnm#)
				)
		 WHERE ROWNUM = 1
	</select>
	
	<!-- 마이스타벅스리뷰 실시간체크 성공건 주문번호 조회 -->
	<select id="msReview.getMsrvOrderNoChkList" parameterClass="java.util.Map" resultClass="java.lang.String">
		WITH XO_ORD AS (
						SELECT TO_NUMBER(#msrv_srnm#) AS MSRV_SRNM
							 , xo.ORDER_NO
							 , xo.ORDER_DATE
							 , TO_CHAR(xo.ORDER_DATE, 'HH24MISS') AS ORDER_TIME
							 , xo.MSR_USER_GRADE
							 , xo.STORE_CD
							 , xo.RECEIVE_TYPE
							 , TO_NUMBER(#birth_yrwn#) AS BIRTH_YRWN
						  FROM XO_ORDER## xo
						 WHERE xo.USER_ID = #user_id#
						   AND TRUNC(SYSDATE) <![CDATA[<=]]> xo.PAY_DATE
						   AND xo.STATUS IN ('30', '31')
						   AND TO_CHAR(xo.ORDER_DATE, 'YYYYMMDD') = TO_CHAR(SYSDATE, 'YYYYMMDD')
						  <isEqual property="tme_chk_yn" compareValue="N">
						   AND xo.ORDER_NO = #curr_order_no#
						  </isEqual> 
						),
		 XO_ORD_DTL AS (
			 			SELECT /*+ USE_NL(xo xod) INDEX(xod PK_XO_ORDER_DETAIL) */
			 				   xo.MSRV_SRNM
			 				 , xo.ORDER_NO
			 				 , xod.SKU_NO
				  		  FROM XO_ORD xo, XO_ORDER_DETAIL xod
				 		 WHERE xo.ORDER_NO = xod.ORDER_NO
				   		   AND xod.SEQ_SUB_NO IS NULL
			 			)
		SELECT xo.ORDER_NO
		  FROM XO_ORD xo
			 , (
			   <isEqual property="bir_chk_yn" compareValue="Y">	
				SELECT xo.ORDER_NO
				  FROM XO_ORD xo, XO_MSRV_AGRP_D ma
				 WHERE xo.MSRV_SRNM = ma.MSRV_SRNM
				   AND xo.BIRTH_YRWN BETWEEN TO_NUMBER(ma.BIRTH_BEGIN_YRWN) AND TO_NUMBER(ma.BIRTH_TRMNT_YRWN)
			   </isEqual>
			   <isEqual property="bir_chk_yn" compareValue="N">	
				SELECT xo.ORDER_NO
  				  FROM XO_ORD xo
			   </isEqual>
				) bir
			 , (
			   <isEqual property="grd_chk_yn" compareValue="Y">	
				SELECT grade.ORDER_NO
				  FROM (
						SELECT xo.ORDER_NO
							 , (CASE WHEN mi.MSR_GRADE_CODE_DTLS IS NULL THEN 'Y'
							 		 WHEN INSTR(mi.MSR_GRADE_CODE_DTLS, xo.MSR_USER_GRADE) > 0 THEN 'Y'
						             ELSE 'N'
						        END) AS GRADE_PASS_YN
						  FROM XO_ORD xo, XO_MSRV_INFRM_M mi
						 WHERE xo.MSRV_SRNM = mi.MSRV_SRNM
				 		) grade
				 WHERE grade.GRADE_PASS_YN = 'Y'
			   </isEqual>
			   <isEqual property="grd_chk_yn" compareValue="N">
				SELECT xo.ORDER_NO
  				  FROM XO_ORD xo
			   </isEqual>	 
				) grd
			 , (
			   <isEqual property="str_chk_yn" compareValue="Y">	
				SELECT store.ORDER_NO
				  FROM (
						SELECT /*+ USE_NL(xo xsa) INDEX(xsa IDX_XO_STORE_ATTR_01) */
							   xo.ORDER_NO
							 , (CASE WHEN ms.STORE_ATRBT_DVSN_CODE = '01' THEN (CASE WHEN ms.DTSTR_RCV_DVSN_CODE = 'A' THEN 'Y'
							 													     WHEN xo.RECEIVE_TYPE = ms.DTSTR_RCV_DVSN_CODE THEN 'Y'
							 														 ELSE 'N'       
							 													END)
							 		 WHEN ms.STORE_ATRBT_DVSN_CODE != '01' THEN 'Y'
							 	END) AS ATTR_PASS_YN
						  FROM XO_ORD xo, XO_STORE_ATTR xsa, XO_MSRV_STORE_D ms
						 WHERE xo.STORE_CD = xsa.STORE_CD
						   AND xo.MSRV_SRNM = ms.MSRV_SRNM
						   AND xsa.ATTR_CD = ms.STORE_ATRBT_DVSN_CODE
					   ) store
				 WHERE store.ATTR_PASS_YN = 'Y'
			   </isEqual>
			   <isEqual property="str_chk_yn" compareValue="N">
				SELECT xo.ORDER_NO
  				  FROM XO_ORD xo
			   </isEqual>
				) str
			 , (
			   <isEqual property="tme_chk_yn" compareValue="Y">	
				SELECT time.ORDER_NO
				  FROM (
						SELECT /*+ INDEX(mt IDX_XO_MSRV_TME_D_001) */
							   xo.ORDER_NO
							 , TO_CHAR(WM_CONCAT(DISTINCT mt.RGSTT_SRNM) OVER (PARTITION BY xo.MSRV_SRNM)) AS TME_RGSTT_SRNM
						  FROM XO_ORD xo, XO_MSRV_TME_D mt
						 WHERE xo.MSRV_SRNM = mt.MSRV_SRNM
						   AND xo.ORDER_TIME BETWEEN mt.SROR_ORDER_BEGIN_TME AND mt.SROR_ORDER_TRMNT_TME
					  	) time
				 WHERE time.TME_RGSTT_SRNM = #tme_rgstt_srnm#
			   </isEqual>
			   <isEqual property="tme_chk_yn" compareValue="N">
				SELECT xo.ORDER_NO
  				  FROM XO_ORD xo
			   </isEqual>	 
				) tme
			 , (
			   <isEqual property="sku_chk_yn" compareValue="Y">	
				SELECT goods1.ORDER_NO
				  FROM (
				  		SELECT /*+ USE_NL(xod mg) */
							   xod.ORDER_NO
							 , COUNT(xod.SKU_NO)
						  FROM XO_ORD_DTL xod, XO_MSRV_GOODS_D mg
						 WHERE xod.MSRV_SRNM = mg.MSRV_SRNM
						   AND mg.PDGR_DVSN_CODE = 'A'
						   AND xod.SKU_NO = mg.APLCT_SKU_CODE
						 GROUP BY xod.ORDER_NO
						HAVING COUNT(xod.SKU_NO) > 0
						) goods1
					 , (
					   <isEqual property="sku_prn_yn" compareValue="Y">	
						SELECT /*+ USE_NL(xod mg) */
							   xod.ORDER_NO
							 , COUNT(xod.SKU_NO)
						  FROM XO_ORD_DTL xod, XO_MSRV_GOODS_D mg
						 WHERE xod.MSRV_SRNM = mg.MSRV_SRNM
						   AND mg.PDGR_DVSN_CODE = 'B'
						   AND xod.SKU_NO = mg.APLCT_SKU_CODE
						 GROUP BY xod.ORDER_NO
						HAVING COUNT(xod.SKU_NO) > 0
					   </isEqual>
					   <isEqual property="sku_prn_yn" compareValue="N">	
						SELECT xo.ORDER_NO
						  FROM XO_ORD xo
					   </isEqual>	
					    ) goods2
				 WHERE goods1.ORDER_NO = goods2.ORDER_NO
			   </isEqual>
			   <isEqual property="sku_chk_yn" compareValue="N">
				SELECT xo.ORDER_NO
  				  FROM XO_ORD xo
			   </isEqual>	 
				) sku
		 WHERE xo.ORDER_NO = bir.ORDER_NO
		   AND xo.ORDER_NO = grd.ORDER_NO
		   AND xo.ORDER_NO = str.ORDER_NO
		   AND xo.ORDER_NO = tme.ORDER_NO
		   AND xo.ORDER_NO = sku.ORDER_NO
		 GROUP BY xo.ORDER_NO, xo.ORDER_DATE
		 ORDER BY xo.ORDER_DATE DESC
	</select>
	
	<!-- 마이스타벅스리뷰 참여대상자 이력등록 -->
	<insert id="msReview.insertMsrvPrtcnTrprH" parameterClass="java.util.Map">
		INSERT
		  INTO XO_MSRV_PRTCN_TRPR_H
		       (
		              MSRV_SRNM
		            , MSRV_PRTCN_HSTRY_SRNM
		            , MSRMB_ID
		            , MSRV_MBBR_DVSN_CODE
		            , SROR_ORDER_DATE
		            , SROR_ORDER_NO
		            , RGSTT_DVSN_CODE
		       )
		       VALUES
		       (
		              TO_NUMBER(#msrv_srnm#)
		            , SE_XO_MSRV_PRTCN_HSTRY.NEXTVAL
		            , #msrmb_id#
		            , #msrv_mbbr_dvsn_code#
		            , (SELECT TO_CHAR(NVL(ORDER_DATE, SYSDATE), 'YYYYMMDD')
						 FROM XO_ORDER##
						WHERE ORDER_NO = #sror_order_no#)
		            , #sror_order_no#
		            , 'XB'
		       )
	</insert>
	
	<!-- 마이스타벅스리뷰 설문 현재 참여인원수 업데이트 -->
	<update id="msReview.updateMsrvPrtcnPrcnt" parameterClass="java.util.Map">
		UPDATE XO_MSRV_INFRM_M
		   SET PRTCN_PRCNT = (
		   					  SELECT COUNT(*)
							    FROM (SELECT /*+ INDEX(mpt IDX_XO_MSRV_PRTCN_TRPR_H_001) */
							    			 mpt.MSRMB_ID
							  		    FROM XO_MSRV_PRTCN_TRPR_H mpt 
							  		   WHERE mpt.MSRV_SRNM = TO_NUMBER(#msrv_srnm#) AND mpt.MSRV_MBBR_DVSN_CODE = 'N'
							 		   GROUP BY mpt.MSRMB_ID)
		   					  ) 
		 WHERE MSRV_SRNM = TO_NUMBER(#msrv_srnm#)
	</update>
	
	<!-- PUSH 이력에서 당일내 가장 최근의 사이렌오더 주문번호 조회 -->
	<select id="msReview.getOrderNoOfPushHist" parameterClass="java.util.Map" resultClass="java.lang.String">
		SELECT hist.SROR_ORDER_NO
		  FROM (
		  		SELECT /*+ USE_NL(mpt xo) INDEX(mpt IDX_XO_MSRV_PRTCN_TRPR_H_001) */
				       mpt.SROR_ORDER_NO
				  FROM XO_MSRV_PRTCN_TRPR_H mpt
				  	 , XO_ORDER## xo
				 WHERE mpt.MSRV_SRNM       = TO_NUMBER(#msrv_srnm#)
				   AND mpt.MSRMB_ID        = #msrmb_id#
				   AND mpt.SROR_ORDER_DATE = TO_CHAR(SYSDATE, 'YYYYMMDD')
				   AND mpt.MSRV_MBBR_DVSN_CODE = 'N'
				   AND mpt.SROR_ORDER_NO   = xo.ORDER_NO
				   AND xo.STATUS IN ('31','30')
				 ORDER BY mpt.MSRV_PRTCN_HSTRY_SRNM DESC
		        ) hist
		 WHERE ROWNUM = 1
	</select>
		
</sqlMap>