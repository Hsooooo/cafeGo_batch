<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="eGiftItemXo">
	
	<resultMap class="java.util.HashMap" id="targetInfoMap">
		<result property="GIFT_ORDER_NO"	column="GIFT_ORDER_NO"		javaType="java.lang.String"/>
		<result property="USER_ID" 			column="USER_ID" 			javaType="java.lang.String"/>
		<result property="SEND_METHOD" 		column="SEND_METHOD" 		javaType="java.lang.String"/>
		<result property="RECEIVER_MOBILE" 	column="RECEIVER_MOBILE"	javaType="java.lang.String"/>
		<result property="GIFT_NO" 			column="GIFT_NO" 	   		javaType="java.lang.String"/>
		<result property="STATUS" 			column="STATUS" 	   		javaType="java.lang.String"/>
		<result property="REG_USER_ID" 		column="REG_USER_ID"		javaType="java.lang.String"/>
		<result property="EXPIRE_DATE" 		column="EXPIRE_DATE"		javaType="java.lang.String"/>
		<result property="NOTICE_TYPE" 		column="NOTICE_TYPE"		javaType="java.lang.String"/>
	</resultMap>
	
	<!-- 만기 알림 대상 조회 -->
	<select id="eGiftItemXo.getEGiftItemExpirationNoticeTarget" parameterClass="java.util.Map" resultMap="targetInfoMap">
		SELECT GIFT_ORDER_NO, USER_ID, SEND_METHOD, RECEIVER_MOBILE, GIFT_NO, STATUS, REG_USER_ID, EXPIRE_DATE, NOTICE_TYPE
		  FROM (
		        SELECT XGO.GIFT_ORDER_NO, XGO.USER_ID, XGO.SEND_METHOD,  
		               XX1.DEC_VARCHAR2_SEL(XGO.RECEIVER_MOBILE, 10, 'PHONE') AS RECEIVER_MOBILE,
		               XGI.GIFT_NO, XGI.STATUS, XGI.REG_USER_ID, XGI.EXPIRE_DATE,
		               CASE
		                   WHEN XGI.REG_USER_ID IS NOT NULL THEN 'A'
		                   ELSE 
		                       CASE
		                           WHEN XGO.SEND_METHOD = 'S' THEN 'B'
		                           ELSE 'C'
		                       END
		               END NOTICE_TYPE
		          FROM XO_GIFT_ORDER## XGO, XO_GIFT_ISSUE## XGI
		         WHERE XGO.GIFT_ORDER_NO = XGI.GIFT_ORDER_NO
				<isEmpty property="thisDate">		  
		   		   AND TO_DATE(XGI.EXPIRE_DATE, 'YYYYMMDD') - #noticeDate# = TO_CHAR(SYSDATE, 'YYYYMMDD')
				</isEmpty>
		        <isNotEmpty property="thisDate">
		           AND XGI.EXPIRE_DATE = #thisDate#
		        </isNotEmpty>
		           AND XGI.STATUS = 'G00'
		       )
		 WHERE NOTICE_TYPE = #noticeType#		 
	</select>
	
	<!-- XO PUSH 발송 요청 테이블에 등록 -->
    <insert id="eGiftItemXo.insertXoTmsQueue" parameterClass="java.util.Map">
		<selectKey resultClass="java.lang.String" keyProperty="reqUid">
            SELECT FN_GET_TMS_QUEUE_REQ_UID(#serverType#) AS reqUid FROM DUAL
        </selectKey>
        INSERT INTO XO_TMS_QUEUE 
		(
		     req_uid
		   , ch_gubun
		   , msg_tp_cd
		   , priority_flag
		   , to_id
		   , content		   
		   <isNotEmpty property="map1">
		   , map1
		   </isNotEmpty>		   
		   <isNotEmpty property="map2">
		   , map2
		   </isNotEmpty>		   
		   <isNotEmpty property="map3">
		   , map3
		   </isNotEmpty>
		   <isNotEmpty property="map4">
		   , map4
		   </isNotEmpty>
		   <isNotEmpty property="map5">
		   , map5
		   </isNotEmpty>
		   <isNotEmpty property="map6">
		   , map6
		   </isNotEmpty>
		   <isNotEmpty property="map7">
		   , map7
		   </isNotEmpty>
		   <isNotEmpty property="map8">
		   , map8
		   </isNotEmpty>
		   <isNotEmpty property="map9">
		   , map9
		   </isNotEmpty>
		   <isNotEmpty property="map10">
		   , map10
		   </isNotEmpty>
		   , app_grp_id
		   <isNotEmpty property="puInApp">
		   , pu_in_app
		   </isNotEmpty>
		   <isNotEmpty property="timetolive">
		   , timetolive
		   </isNotEmpty>
		   <isNotEmpty property="pushValue">
		   , push_value
		   </isNotEmpty>
		   <isNotEmpty property="imgUrl">
		   , img_url
		   </isNotEmpty>
		   <isNotEmpty property="data01">
		   , data01
		   </isNotEmpty>
		   <isNotEmpty property="data02">
		   , data02
		   </isNotEmpty>
		   <isNotEmpty property="data03">
		   , data03
		   </isNotEmpty>
		   , target_flag
		   , reserv_date
		   , reg_date
		   , push_insert_table
		   , push_insert_yn
		   <isNotEmpty property="pushType">
		   , push_type
		   </isNotEmpty>
		 ) VALUES (
		     #reqUid#
		   , #chGubun#
		   , #msgTpCd#
		   , #priorityFlag#
		   , #toId#
		   , #content#
		   <isNotEmpty property="map1">
		   , #map1#
		   </isNotEmpty>
		   <isNotEmpty property="map2">
		   , #map2#
		   </isNotEmpty>
  		   <isNotEmpty property="map3">
		   , #map3#
		   </isNotEmpty>
		   <isNotEmpty property="map4">
		   , #map4#
		   </isNotEmpty>
		   <isNotEmpty property="map5">
		   , #map5#
		   </isNotEmpty>
		   <isNotEmpty property="map6">
		   , #map6#
		   </isNotEmpty>
		   <isNotEmpty property="map7">
		   , #map7#
		   </isNotEmpty>
		   <isNotEmpty property="map8">
		   , #map8#
		   </isNotEmpty>
		   <isNotEmpty property="map9">
		   , #map9#
		   </isNotEmpty>
		   <isNotEmpty property="map10">
		   , #map10#
		   </isNotEmpty>
		   , #appGrpId#
		   <isNotEmpty property="puInApp">
		   , #puInApp#
		   </isNotEmpty>
		   <isNotEmpty property="timetolive">
		   , #timetolive#
		   </isNotEmpty>
		   <isNotEmpty property="pushValue">		   
		   , #pushValue#
		   </isNotEmpty>
		   <isNotEmpty property="imgUrl">
		   , #imgUrl#
		   </isNotEmpty>
		   <isNotEmpty property="data01">
		   , #data01#
		   </isNotEmpty>
		   <isNotEmpty property="data02">		   
		   , #data02#
		   </isNotEmpty>
		   <isNotEmpty property="data03">
		   , #data03#
		   </isNotEmpty>
		   , 'N'
		   , TO_CHAR (SYSDATE, 'YYYYMMDDHH24MISS')
		   , SYSDATE
		   , #pushInsertTable#
		   , 'N'
		   <isNotEmpty property="pushType">
		   , #pushType#
		   </isNotEmpty>
		 )
    </insert>
    
	<!-- TMS_PERSON_QUEUE에 정상 Push 등록 여부 업데이트 -->
	<update id="eGiftItemXo.updateXoTmsQueue" parameterClass="java.util.Map">
		UPDATE XO_TMS_QUEUE
   		   SET push_insert_yn = 'Y'
 		 WHERE req_uid = #reqUid#
    </update>
    
    <!-- LMS 이력 등록 -->
    <insert id="eGiftItemXo.setSendHistory" parameterClass="java.util.Map">
		INSERT INTO XO_GIFT_SEND_LMS_HISTORY (
		    GIFT_ORDER_NO, USER_ID, SEND_TYPE, MT_PR, REG_DATE, CHANNEL 
		)
		VALUES (
		    #giftOrderNo#, #userId#, #sendType#, #mt_pr#, SYSDATE, #channel#
		)
    </insert>
    
    <!-- 예약 발송 후 INBOX 전송 여부 등록 -->
    <update id="eGiftItemXo.updateReserveInbox" parameterClass="java.lang.String">
    	UPDATE XO_GIFT_ORDER##
    	   SET RESERVE_INBOX = 'Y'
    	 WHERE GIFT_ORDER_NO = #giftOrderNo#
    </update>
</sqlMap>