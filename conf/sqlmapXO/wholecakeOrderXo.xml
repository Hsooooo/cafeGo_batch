<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="wholecakeOrderXo">

	<!-- 발주 확정일자가 오늘일 홀케익 예약정보 조회  -->
	<select id="wholecakeOrderXo.getWholecakeOrderList" parameterClass="java.util.Map" resultClass="co.kr.istarbucks.xo.batch.common.dto.xo.WholecakeOrderDto">
	    SELECT xwo.order_no
	         , xwo.policy_cd
	         , UTL_RAW.CAST_TO_RAW(xwo.order_name) AS order_name
	         , xwo.user_id
	         , UTL_RAW.CAST_TO_RAW(xwo.user_name) AS user_name
	         , xwo.receive_store_cd
	         , xwo.receive_date
	         , xwo.sales_order_date <!-- 발주 확정 일자 -->
	         , xwo.revocable_date
	         , xwo.total_qty
	         , nvl(xwo.total_pay_amt, 0) AS total_pay_amt
	         , nvl(xwo.total_discount, 0) AS total_discount
	         , nvl(xwo.total_coupon, 0) AS total_coupon
	         , xwo.total_item_amount
	         , CASE
	            WHEN ( SELECT count(*)
	                    FROM XO_WHOLECAKE_ORDER_HISTORY##
	                   WHERE order_no = xwo.order_no
	                     AND status = 'P11') > 0 THEN 'Y'
	            ELSE 'N'
	           END AS present_resend_yn
	         , xwo.present_status
	         , xwo.pay_date 
	         , xwod.item_seq
	         , xwod.sku_no
	         , xwod.price
	         , xwod.qty
	         , NVL(xwod.item_amount, 0) AS item_amount
	         , NVL(xwod.discount, 0) AS discount
	         , NVL(xwod.gnd_amount, 0) AS gnd_amount 
	         , xwod.cate_type
	         , xwod.coupon_number
	         , NVL(xwod.coupon_dc_amt, 0) AS coupon_dc_amt
	         , xwod.sck_coupon_no
             , xwod.status
             , (
                SELECT xwrd.sales_order_date
                  FROM XO_WHOLECAKE_RECEIVE_DATE xwrd
                 WHERE xwrd.receive_date = xwo.receive_date
                   AND xwrd.sales_order_confirm_date = xwo.sales_order_date
                   AND receive_choice_yn = 'Y'
               ) AS order_date <!-- 영업정보 저장용 발주일자  -->                 
	      FROM XO_WHOLECAKE_ORDER## xwo, XO_WHOLECAKE_ORDER_DETAIL xwod
	     WHERE
               <isNotEmpty property="salesOrderDate">
		       xwo.sales_order_date = #salesOrderDate#
		       </isNotEmpty>
		       <isEmpty property="salesOrderDate">
		       xwo.sales_order_date = TO_CHAR(SYSDATE, 'YYYYMMDD')
		       </isEmpty>
	       AND xwo.status = 'O11'
	       AND xwo.use_flag = 'Y'
	       AND xwo.order_no = xwod.order_no
	     ORDER BY xwo.order_no, xwod.item_seq ASC
	</select>

	<!-- 사이렌오더 XO_ORDER_WHOLECAKE의 STATUS값 O20(발주확정)으로 업데이트 -->
	<update id="wholecakeOrderXo.updateWholecakeOrder" parameterClass="co.kr.istarbucks.xo.batch.common.dto.xo.WholecakeOrderDto">
	     UPDATE XO_WHOLECAKE_ORDER##
            SET status = 'O20'
              , sales_order_comp_flag = 'Y'
          WHERE order_no = #order_no#            
            AND user_id = #user_id#
            AND use_flag = 'Y'
	</update>

	<!-- 사이렌오더 XO_ORDER_HISTORY_WHOLECAKE의 STATUS값 O20으로 히스토리 등록 -->
	<insert id="wholecakeOrderXo.insertWholecakeOrderHistory" parameterClass="co.kr.istarbucks.xo.batch.common.dto.xo.WholecakeOrderDto">		            
	    INSERT INTO XO_WHOLECAKE_ORDER_HISTORY## (
	       order_no
	     , status                        
	     , history_channel               
	     , app_disp_yn
	     , reg_date
	    ) VALUES ( 
	       #order_no#
	     , 'O20'
	     , '4'
	     <!-- 홀케익 선물 정보가 없다면 APP 노출  Y -->
	     <isEmpty property="present_status">
		 , 'Y' 
		</isEmpty>
		<!-- 홀케익 선물 정보가 있다면 -->
		<isNotEmpty property="present_status">
		<!-- 선물 완료인 경우 APP 노출 N -->
		 <isEqual property="present_status" compareValue="P10">
		 , 'N'
		 </isEqual>
		 <!-- 선물 거절인 경우 APP 노출 Y -->
		 <isEqual property="present_status" compareValue="P20"> 
		 , 'Y'
		 </isEqual>
		</isNotEmpty>     
	     , SYSDATE
	    )
	</insert>
	
	<!-- 홀케익 예약 쿠폰 발송 대상 예약 추출 -->
	<select id="wholecakeOrderXo.getWholeCakeOrderListForCoupon" parameterClass="java.util.Map" resultClass="co.kr.istarbucks.xo.batch.common.dto.xo.WholecakeOrderDto">
		SELECT /*+ INDEX(wo IDX_XO_WHOLECAKE_ORDER_05) */
               /* [wholecakeOrderXo.xml][wholecakeOrderXo.getWholeCakeOrderListForCoupon] */
		       wo.order_no,                 <!-- 예약번호  --> 
		       wo.msr_user_flag,            <!-- MSR회원여부{Y-회원, N-비회원} -->
		       wo.total_qty,                <!-- 전체 수량 -->
		       pw.coupon_count,             <!-- 홀케익 예약 정책의 쿠폰 발행 개수 -->
		       (
                (NVL(wo.total_qty, 0) - (SELECT COUNT(*) FROM XO_WHOLECAKE_ORDER_DETAIL WHERE order_no = wo.order_no AND coupon_number IS NOT NULL)) * NVL(pw.coupon_count, 0)
               ) AS total_coupon_count,		<!-- 해당 예약의 쿠폰 발행 수 ((케익수- 홀케익쿠폰사용수)* 정책 쿠폰) -->
		       wo.order_name,
		       wo.user_id,
		       UTL_RAW.CAST_TO_RAW(wo.user_name) AS user_name,
		       XX1.DEC_VARCHAR2_SEL(wo.user_mobile    , 10, 'PHONE') AS user_mobile, 
		       XX1.DEC_VARCHAR2_SEL(wo.user_email     , 11, 'MAIL') AS user_email,
		       wo.policy_cd                 <!-- 정책코드 -->
		  FROM XO_WHOLECAKE_ORDER## wo
		       INNER JOIN XO_POLICY_WHOLECAKE pw ON pw.policy_cd = wo.policy_cd
		 WHERE 
		   <isNotEmpty property="salesOrderDate">
		       wo.sales_order_date = #salesOrderDate#
		   </isNotEmpty>
		   <isEmpty property="salesOrderDate">
		       wo.sales_order_date = TO_CHAR(SYSDATE, 'YYYYMMDD')
		   </isEmpty>
		   AND wo.sales_order_comp_flag = 'Y'
           AND wo.status = 'O20'
           AND wo.use_flag = 'Y'
           AND (
               wo.coupon_pub_flag != 'Y'
               OR wo.coupon_pub_flag IS NULL
               )
	</select>
	
	<!-- 홀케익 쿠폰 MMS 이미지 조회 -->
	<select id="wholecakeOrderXo.getWholeCakeCouponMMSImageList" parameterClass="java.util.Map" resultClass="co.kr.istarbucks.xo.batch.common.dto.xo.WholecakeOrderDetailDto">
        SELECT /* [wholecakeOrderXo.xml][wholecakeOrderXo.getWholeCakeCouponMMSImageList] */
               wod.order_no, wod.sku_no, wod.qty, si.file_path, si.file_name
          FROM XO_WHOLECAKE_ORDER_DETAIL wod 
               INNER JOIN XO_SKU_IMAGE si ON si.sku_no = wod.sku_no AND si.image_type = '2'
		 WHERE wod.order_no = #orderNo#
	</select>
	
	<!-- 홀케익 예약 쿠폰 발행 완료 처리 -->
	<update id="wholecakeOrderXo.updateWholeCakeOrderForCouponPubFlag" parameterClass="java.util.Map">
		UPDATE /* [wholecakeOrderXo.xml][wholecakeOrderXo.updateWholeCakeOrderForCouponPubFlag] */
		       XO_WHOLECAKE_ORDER##
		   SET coupon_pub_flag = 'Y'
		 WHERE 
		 <isNotEmpty property="orderNoList">
		       <iterate property="orderNoList" prepend="order_no IN " open="(" close=")" conjunction=",">#orderNoList[]#</iterate>	
		 </isNotEmpty> 
		 <isEmpty property="orderNoList">
		       1 = 0
		 </isEmpty>
	</update>

	<!-- 홀케익 예약 확인 LMS 발송 대상자 추출 -->
	<select id="wholecakeOrderXo.getWholeCakeOrderListForLms" parameterClass="java.util.Map" resultClass="co.kr.istarbucks.xo.batch.common.dto.xo.WholecakeOrderDto">
        SELECT /*+ INDEX(wo IDX_XO_WHOLECAKE_ORDER_07) */
               /* [wholecakeOrderXo.xml][wholecakeOrderXo.getWholeCakeOrderListForLms] */
               wo.order_no,                          <!-- 예약번호  --> 
               wo.order_name,                 
               wo.user_id,
               wo.user_name,
               XX1.DEC_VARCHAR2_SEL(wo.user_mobile, 10, 'PHONE') AS user_mobile,
               wo.receive_store_cd,
               xs.store_name AS receive_store_name,   <!-- 수령 매장 명 -->
               wo.total_qty,                          <!-- 전체 수량 -->
               wo.os_type,
               wo.push_id,
               TO_CHAR(TO_DATE(wo.receive_date,   'YYYYMMDD'), 'YYYY/MM/DD') AS receive_date,             <!-- 수령일 -->
               TO_CHAR(TO_DATE(wo.revocable_date, 'YYYYMMDD'), 'YYYY/MM/DD') AS revocable_date            <!-- 취소 가능일 -->
          FROM XO_WHOLECAKE_ORDER## wo
               INNER JOIN XO_STORE xs                   ON xs.store_cd = wo.receive_store_cd
         WHERE 
		   <isNotEmpty property="revocableDate">
		       wo.revocable_date = #revocableDate#
		   </isNotEmpty>
		   <isEmpty property="revocableDate">
		       wo.revocable_date = TO_CHAR(SYSDATE, 'YYYYMMDD')
		   </isEmpty>         
           AND wo.status = 'O11'
           AND wo.use_flag = 'Y'
	</select>
	
	<!-- 홀케익 예약 상태 알림 등록 -->
	<insert id="wholecakeOrderXo.insertWholecakeOrderNoti" parameterClass="co.kr.istarbucks.xo.batch.common.dto.xo.WholecakeOrderNotiDto">
		INSERT /* [wholecakeOrderXo.xml][wholecakeOrderXo.insertWholecakeOrderNoti] */ 
		  INTO XO_WHOLECAKE_ORDER_NOTI (
		         order_no
		       , status
		       , noti_type
		       , noti_user
		       <isNotEmpty property="mt_pr">
		       <isNotEqual property="mt_pr" compareValue="0">
		       , mt_pr
		       </isNotEqual>
		       </isNotEmpty>
		       <isNotEmpty property="email_seq">
		       <isNotEqual property="email_seq" compareValue="0">
		       , email_seq
		       </isNotEqual>
		       </isNotEmpty>
		       , reg_date
		       ) 
		VALUES (
		         #order_no#               <!-- 예약번호 -->
		       , #status#                 <!-- 예약/선물상태 -->
		       , #noti_type#              <!-- 알림 타입{M-MMS, L-LMS, S-SMS, E-EMAIL} -->
		       , #noti_user#              <!-- 알림 대상{O-예약자, P-선물수신자} -->
		       <isNotEmpty property="mt_pr">
		       <isNotEqual property="mt_pr" compareValue="0">
		       , #mt_pr#                  <!-- 메세지 고유 아이디 -->
		       </isNotEqual>
		       </isNotEmpty>
		       <isNotEmpty property="email_seq">
		       <isNotEqual property="email_seq" compareValue="0">
		       , #email_seq#              <!-- 이메일 발송 일련번호 -->
		       </isNotEqual>
		       </isNotEmpty>
		       , SYSDATE                  <!-- 등록일 -->
		       )
	</insert>
	
	<resultMap id="wholecakeOrderCountMap" class="java.util.HashMap">
		<result property="count" column="count" javaType="Integer" />
		<result property="totalQty" column="totalQty" javaType="Integer" />
	</resultMap>
	
	<!-- 발주 확정일자의 전일 발주 확정 카운터 조회  -->
	<select id="wholecakeOrderXo.getYesterdayWholecakeOrderConfirm" parameterClass="java.util.Map" resultMap="wholecakeOrderCountMap">
	    SELECT COUNT(*) AS count, NVL(SUM(xwo.total_qty), 0) AS totalQty                 
          FROM XO_WHOLECAKE_ORDER## xwo
         WHERE 
               <isNotEmpty property="salesOrderDate">
		       xwo.sales_order_date = #salesOrderDate#
		       </isNotEmpty>
		       <isEmpty property="salesOrderDate">
		       xwo.sales_order_date = TO_CHAR(SYSDATE - 1, 'YYYYMMDD')
		       </isEmpty>
           AND xwo.status = 'O20'
           AND xwo.sales_order_comp_flag = 'Y'
	</select>
		
	<!-- 홀케익 예약 상태 알림 등록(XO PUSH 발송 요청 테이블에 등록) -->
    <insert id="wholecakeOrderXo.insertWholecakeOrderPush" parameterClass="java.util.Map">
		<selectKey resultClass="java.lang.String" keyProperty="reqUid">
            SELECT FN_GET_TMS_QUEUE_REQ_UID(#serverType#) AS reqUid FROM DUAL
        </selectKey>
        INSERT INTO XO_TMS_QUEUE 
		(
		     req_uid
		   , ch_gubun
		   , msg_tp_cd
		   , priority_flag
		   , to_id
		   , content		   
		   <isNotEmpty property="map1">
		   , map1
		   </isNotEmpty>		   
		   <isNotEmpty property="map2">
		   , map2
		   </isNotEmpty>		   
		   <isNotEmpty property="map3">
		   , map3
		   </isNotEmpty>
		   <isNotEmpty property="map4">
		   , map4
		   </isNotEmpty>
		   <isNotEmpty property="map5">
		   , map5
		   </isNotEmpty>
		   <isNotEmpty property="map6">
		   , map6
		   </isNotEmpty>
		   <isNotEmpty property="map7">
		   , map7
		   </isNotEmpty>
		   <isNotEmpty property="map8">
		   , map8
		   </isNotEmpty>
		   <isNotEmpty property="map9">
		   , map9
		   </isNotEmpty>
		   <isNotEmpty property="map10">
		   , map10
		   </isNotEmpty>
		   , app_grp_id
		   <isNotEmpty property="puInApp">
		   , pu_in_app
		   </isNotEmpty>
		   <isNotEmpty property="timetolive">
		   , timetolive
		   </isNotEmpty>
		   <isNotEmpty property="pushValue">
		   , push_value
		   </isNotEmpty>
		   <isNotEmpty property="imgUrl">
		   , img_url
		   </isNotEmpty>
		   <isNotEmpty property="data01">
		   , data01
		   </isNotEmpty>
		   <isNotEmpty property="data02">
		   , data02
		   </isNotEmpty>
		   <isNotEmpty property="data03">
		   , data03
		   </isNotEmpty>
		   , target_flag
		   , reserv_date
		   , reg_date
		   , push_insert_table
		   , push_insert_yn
		   <isNotEmpty property="pushType"> 
		   , push_type
		   </isNotEmpty>
		 ) VALUES (
		     #reqUid#
		   , #chGubun#
		   , #msgTpCd#
		   , #priorityFlag#
		   , #toId#
		   , #content#
		   <isNotEmpty property="map1">
		   , #map1#
		   </isNotEmpty>
		   <isNotEmpty property="map2">
		   , #map2#
		   </isNotEmpty>
  		   <isNotEmpty property="map3">
		   , #map3#
		   </isNotEmpty>
		   <isNotEmpty property="map4">
		   , #map4#
		   </isNotEmpty>
		   <isNotEmpty property="map5">
		   , #map5#
		   </isNotEmpty>
		   <isNotEmpty property="map6">
		   , #map6#
		   </isNotEmpty>
		   <isNotEmpty property="map7">
		   , #map7#
		   </isNotEmpty>
		   <isNotEmpty property="map8">
		   , #map8#
		   </isNotEmpty>
		   <isNotEmpty property="map9">
		   , #map9#
		   </isNotEmpty>
		   <isNotEmpty property="map10">
		   , #map10#
		   </isNotEmpty>
		   , #appGrpId#
		   <isNotEmpty property="puInApp">
		   , #puInApp#
		   </isNotEmpty>
		   <isNotEmpty property="timetolive">
		   , #timetolive#
		   </isNotEmpty>
		   <isNotEmpty property="pushValue">		   
		   , #pushValue#
		   </isNotEmpty>
		   <isNotEmpty property="imgUrl">
		   , #imgUrl#
		   </isNotEmpty>
		   <isNotEmpty property="data01">
		   , #data01#
		   </isNotEmpty>
		   <isNotEmpty property="data02">		   
		   , #data02#
		   </isNotEmpty>
		   <isNotEmpty property="data03">
		   , #data03#
		   </isNotEmpty>
		   , 'N'
		   , TO_CHAR (SYSDATE, 'YYYYMMDDHH24MISS')
		   , SYSDATE
		   , #pushInsertTable#
		   , 'N'
		   <isNotEmpty property="pushType"> 
		   , #pushType#
		   </isNotEmpty>
		 )
    </insert>
    
	<!-- TMS_PERSON_QUEUE에 정상 Push 등록 여부 업데이트 -->
	<update id="wholecakeOrderXo.updateWholecakeOrderPush" parameterClass="java.util.Map">
		UPDATE XO_TMS_QUEUE
   		   SET push_insert_yn = 'Y'
 		 WHERE req_uid = #reqUid#
    </update>  
</sqlMap>